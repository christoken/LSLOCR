<!DOCTYPE html> 
<html>
<head>
	<title>LSL OCR Scanner</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">	
		 <meta charset="UTF-8">
	 <link rel="stylesheet" href="css/datepicker.css">	
	 <link rel="stylesheet" href="css/jquery.mobile-1.3.1.min.css" />
	 <link rel="stylesheet" href="css/jquery-ui.css">
	<!-- link to jQuery and jQuery Mobile JavaScript libraries: -->
	<script src="js/jquery-1.10.1.min.js"></script>
	<script src="js/jquery.mobile-1.3.1.min.js"></script>	 	 
	 <script src="js/jquery-ui.js"> </script>	 	 
	 <script src="js/datepicker.js"></script>
	<script type="text/javascript" src="cordova.js"></script> 	
	 <script src="https://api.mqcdn.com/sdk/mapquest-js/v1.3.2/mapquest.js"></script>
    <link type="text/css" rel="stylesheet" href="https://api.mqcdn.com/sdk/mapquest-js/v1.3.2/mapquest.css"/>

	<!--<script 	  src="http://maps.google.com/maps/api/js?key=AIzaSyBlRL7HLQhCd-rz7DdB5aKTe63kFk8jBPM&ver&sensor=false">
	
	</script>	
	
	AIzaSyCNOiO5P22wUCCOe7MIquPFPps4b6N3LAI // old working key
	AIzaSyAPxbNErnG4KdzBZ3Xj_8810LzCJpFDQ0A //
	//AIzaSyBlRL7HLQhCd-rz7DdB5aKTe63kFk8jBPM //current key
	-->
 <script>
	var serverURL="http://localhost/meetUP/server/"; // The server address of the PHP files
	var baseURL="http://localhost/meetUP/";
	var serverURL="http://3modernsystems.com/meetUP/server/"; // The server address of the PHP files
	var baseURL="http://3modernsystems.com/meetUP/";
	L.mapquest.key = '1GSDb5IzqcbV0rHMAlJR99A8TsGN7Q6H';
	
	var fingerOrPin=0; 
	var acAddress="";
	var simSerial1="";
	var simSerial2="";
	var saveORlog=3;//0 is log 1 is save new points
	var globalusn="";
	var globalNames="";
	var globalTelNo="";
	//var logtype=2;
	//0 is fingerprint, 1 is pin.
 </script>
</head>
<!-- <body  onpageshow="checkonPageshow()"   style="display: mfloginPage;"> -->

<body  onpageshow="checkonPageshow()"   style="display: manualcapture;">
	<div id="dialog" title="OCR">
		<p id="alertclass1">LSL OCR</p>
	</div>
<!-- the div below is a page - the home page -->
<div data-role="page" id="mfloginPage" >
   <script>
   $(document).ready(function(){
   
		$("#btnlogin").click(function(){
		document.getElementById("loginerror").innerHTML="";
		var username= $("#loginId").val();
		var password=$("#loginPassword").val();	
		
		if(username=='' && password==''){
		var response="Please fill out the required fields";
		displayAlert(response);
		//alert("Please fill out the form");
		}
		else if(username=='' && password!==''  ){alert('Username field is required')}
		else if(password=='' && username!=='' ){alert('Password field is required')}
		
		else{	
		var url=serverURL + "loginmobile.php";
			$.ajax(
			{
				// Post select to url.
				"method" : 'post',
				"url" : url,
				async: true,
				//crossDomain: true,
				dataType : 'json', // expected returned data format.
				
				data : {
						'username':username,
						'password':password
						
			   },
				success : function(data, textStatus, jqXHR){               
				// alert(data);//"response" receives - whatever written in echo of above PHP script.
				var size= data.length;
				//alert(size);
			if(size>2)  {			
			var pc = data.split('_');						
			var username=pc[0]; 
			var names=pc[1];
			var telNo=pc[2];
			var pwdChange=pc[3];			
			
			if(pc[3]=='0'){
			//not yet changed your password and hence directed to change password			
			window.location.replace("index.html#changePassword");
			//window.location.href = baseURL +"index.html#changepassword";
			//location.reload();
			}else{
				storeSession(username,names,telNo,telNo);//call function to say if we are logged in						
			   //window.location.href = baseURL +"index.html#homePage"; //direct to the homepage if login is successfull 
				//window.location.replace(baseURL +"index.html#payrollChanges") ;
				window.location.replace("index.html#manualcapture") ;
			}
			}
			else {
			//document.getElementById("dialog").innerHTML="Loging error: Your login failed. Ensure that your email is verified and that your password, username or organization is correct and that your trial period has not expired.";
				//displayAlert();
				//alert("Login Failure: Login page");
		var response="Loging error: Your login failed. Ensure that your email is verified, your password, username or organization is correct and that your trial period has not expired.";
		displayAlert(response);				
		document.getElementById("loginerror").innerHTML="Loging error: Your login failed. Ensure that your email is verified, your password, username or organization is correct and that your trial period has not expired.";
				
			    }
				},
				error: function(jqXHR, textStatus, errorThrown){
					alert(errorThrown,textStatus );
			},
				complete : function(data){
					// do something, not critical.
			}
			});
		}
		
		});
			
		});
   </script>
         <div data-role="header" data-theme="d">
           <!-- <a data-iconpos="notext" href="#Registrationpage" data-role="button" data-icon="back"></a>-->
			 <a  data-role="button" data-icon="home" title="Home" href="#Registrationpage"> </a>
			
            <h1>LSL Login</h1>
         </div>
		 
         <div data-role="content" role="main">
            
			<div class="ui-block"><input onblur="checkLengthLogin(this,'loginerror','#btnlogin')" type="text" required="required" placeholder="Username" id="loginId" value="" maxlength="12"/></div>
            <div class="ui-block"><input onblur="checkLengthLogin(this,'loginerror','#btnlogin')" type="password" required="required" placeholder="Password" id="loginPassword" value="" maxlength="12"/></div>
              
		   <div ><a data-role="button"  data-icon="flat-settings" data-theme="e" id="btnlogin" >Log in</a></div>
			 <!-- <div class="ui-block"><a data-role="button" type="submit" required="required" data-icon="flat-settings" data-theme="d" id="btnlogin" >Login</a></div>--> 
            <div id="loginerror"> </div>
         </div>
         <div data-role="footer" data-theme="d">
               <h1>&copy;LSL</h1>
         </div>
      </div>
<div data-role="page" id="manualcapture">

	<!-- the div below is the home page's header -->
	<div data-role="header">
		<h1>Manual</h1>
		<div data-role="navbar">
	        <ul>
	            <li><a href="#manualcapture"  class="ui-btn-active ui-state-persist" data-icon="star">Manual</a></li>
				<li><a href="#ocrcapture" data-icon="star">OCR</a></li>
				<li><a href="#searchMember"  data-icon="star">Search</a></li>
						
	        </ul>
	    </div>
		<h4 id="sessionText"></h4>
	</div>
	<!-- the div below is the home page's main content -->
	<div data-role="content">
	<script>
	$(document).ready(function(){	
		var urlPF=serverURL +"selectpfIDNo.php";		
		$("#pfIDNo").blur(function() {
		var pfIDNo=$("#pfIDNo").val();
                $.ajax({
                    url: urlPF,
                    dataType: "json",
                    type:"POST",
					data : {
			pfIDNo:pfIDNo		
			},
        success: function (data) {                    
			var JSONString = JSON.stringify(data);		
			var obj=JSON.parse(JSONString);			
			var pf=	obj[0].pf_number;	
			var id=obj[0].id_number;
			var surname=obj[0].surname;
			var othernames=obj[0].othernames;
			var assignment_code=obj[0].assignment_code;
		$("#empNames").val (surname+" "+othernames);
		$("#assignment").val(assignment_code);				
                 },
            }); 
			});
		/*	
		$('#pfIDNo').autocomplete({ //beginning of animal breed autocomplete
            minLength: 4,
            source: function(request, response,term) {
			console.log("Pressed key");
                var param = request.term;
                $.ajax({
                    url: urlPF,
                    dataType: "json",
                    type:"POST",
                    success: function (data) {
                         array=($.map(data, function(item) {						 
                             return { 
                                 label: item.pf_number +" => " + item.surname,   //I am displaying both label and value                        
                                 surname: item.surname,
								 othernames:item.othernames,
								 value: item.pf_number,
								 assignment: item.assignment_code
                                 };								 
                             }));//END Success
							 response($.ui.autocomplete.filter(array, request.term));
							 //console.log("term is "+request.term);							 
                        },
                });//END AJAX
            },
            select: function(event, ui ) { // 
			$("#empNames").val (ui.item.surname+" "+ui.item.othernames);
			$("#assignment").val(ui.item.assignment);			
               //console.log("Name is "+ui.item.label);
			   //console.log("PF is "+ui.item.value);
			   //console.log("Ass is "+ui.item.assignment);
            } 
        });	*/
		
	var urlAss=serverURL +"selectAssignment.php";			
		$('#assignment').autocomplete({ //beginning of animal breed autocomplete
            minLength: 4,
            source: function(request, response,term) {
			console.log("Pressed key");
                var param = request.term;
                $.ajax({
                    url: urlAss,
                    dataType: "json",
                    type:"POST",
                    success: function (data) {
                         array=($.map(data, function(item) {						 
                             return { 
							 
                           label: item.assignment_code +" => " + item.assignment_name,                                 
						   value: item.assignment_code
								
                                 };								 
                             }));//END Success
							 response($.ui.autocomplete.filter(array, request.term));
							 //console.log("term is "+request.term);							 
                        },
                });//END AJAX
            },
            select: function(event, ui ) { // 
			
            } 
        });				
		
		$("#btnSavePaychanges").click(function(){
		 saveORlog=1;
		if($("#pfIDNo").val()!='' && $("#empNames").val()!='' && $("#assignment").val()!='' && $("#dateDeployedLeft").val()!='' &&
		$("#salaryMonth").val()!='' && $("#daysWorked").val()!='' && $("#changeType").val()!=''){
			//findPhone();
			var x;
			var y=$('#changeType option:selected').text();
			if($("#changeType").val()==1){
			x="Remove guard";
			}
			else {
			x="Add guard";
			}
			
			
			logSavePayAlert("Are you sure you want to "+y+" ?");
			//getLocation();
		}else {
			displayAlert("You need to enter the required details to proceed");
		return;
		}
	
		});
		
	});
		</script>
		<div id="payDetails">
		
	<div class="ui-grid-a ui-responsive">
	 <div class="ui-block-a" style="width:30%"><label><b>PF/ID No.:</b> </label> </div>
	<div class="ui-block-b" style="width:70%">  <input type="text" required="required" data-clear-btn="true" placeholder="PF/ID No:" id="pfIDNo"/></div>
	<div class="ui-block-a" style="width:30%" ><label> <b>Name:</b> </label> </div>
	<div class="ui-block-b" style="width:70%" >   <input type="text" required="required" data-clear-btn="true" placeholder="Names:" id="empNames"/></div>
	<div class="ui-block-a" style="width:30%" ><label><b>Assignment:</b> </label> </div>
	<div class="ui-block-b" style="width:70%" >   <input type="text" required="required" data-clear-btn="true" placeholder="Assignment:" id="assignment"/></div>
	<div class="ui-block-a" style="width:30%" ><label><b>Date</b> </label> </div>
	<div class="ui-block-b" style="width:70%" ><input type="date" placeholder="Date Deployed/Left:" id="dateDeployedLeft" data-inline="true" data-toggle="datepicker"/></div>
	<!--
	<div class="ui-block-a" style="width:30%" ><label><b>Period:</b> </label> </div>
	<div class="ui-block-b" style="width:70%" ><input type="date" placeholder="Salary Month:" id="salaryMonth" data-inline="true" data-toggle="datepicker"/></div>
	-->
	<div class="ui-block-a" style="width:30%" ><label align="centre"><b>Days:</b> </label> </div>
	<div class="ui-block-b" style="width:70%" ><input type="number" placeholder="Days Worked" id="daysWorked"/></div>
	<div class="ui-block-a" style="width:30%" ><label><b>Change Type:</b> </label> </div>
	<div class="ui-block-b" style="width:70%" >	
		<select name="changeType" id="changeType">
			<option value="" >Select</option>
			<option value="0">Leave Reliever</option>
			<option value="0">Additional guards</option>
			<option value="0">Off Reliever</option>
			<option value="0">Replacement</option>
			<option value="0">New Employee</option>
			<option value="0">New Assignment</option>
			<option value="1">Old guard leaving</option>
			<option value="1">Terminated Assignment</option>  			
	  </select>
	  </div>
	</div>		
		
	</div>

	<div class="ui-grid-a ui-responsive">
	
			<div class="ui-block-a"> <a data-role="button" data-icon="flat-settings" data-theme="d" id="btnSavePaychanges" >Submit.</a></div>
			
			<div class="ui-block-b"> <a onclick="exitAlert('Are you sure you want exit App?');" data-role="button" data-icon="flat-settings" data-theme="e" id="btnExitPC" >Exit App</a></div>
			
	</div>	
	</div>

	<!-- the div below is the home page's footer -->
	<div data-role="footer">
		<h4>Location Log  &copy;Lavington Security Limited</h4>		
		<a href="app-debug.3516483.102.apk" target="_blank">Download APP</a>
	
	</div>
</div>

<!-- the div below is a page - the about page -->
<div data-role="page" id="ocrcapture">
	<div data-role="header">
		<h1>OCR</h1>
		<div data-role="navbar">
	        <ul>
				<li><a href="#manualcapture"  data-icon="star">Manual</a></li>
				<li><a href="#ocrcapture" class="ui-btn-active ui-state-persist" data-icon="star">OCR</a></li>				
	            <li><a href="#searchMember"  data-icon="star">Search</a></li>	
												
				</ul>
	    </div>
	</div>
	<div data-role="content">
			<script>
		$(document).ready(function(){
		
		$("#btnCapture").click(function(){
			//saveORlog=0;
			//logtype=0;
			//if($("#loc_telNo").val()!=''){
			//check if the person has logged upto five in a day. 
	createStorage();
	if(checkLogingLimit()){	
	//findPhone();
	//logAlert("Are you sure you want to log?");
	   //getLocation();
	   getCameraImage();
	  // increaseLogCount();   
	}
	else{
	alert("You seem to have reached your limit of loging");
	
	}

			//findPhone();
			//logAlert("Are you sure you want to log?");
			//getLocation();
		/*}else {
			displayAlert("You need to enter your Tel # to proceed");
		return;
		}*/
	
		});
	});
		</script>
	<div id="captureDetails">
	<div class="ui-block">
		<select name="captureType" id="captureType">
			<option value="0">New ID</option>
			<option value="1">Old ID</option>
			<option value="2">Passport</option>
			<option value="3">Drivers Licence</option>
			<option value="4">Vehicle</option>    
	  </select>
	</div>
		
		<p>Names: <span id="visitornames"></span></p>
		<p>ID No: <span id="id_number"></span></p>
		<p>Vehicle Reg. No: <span id="vehicle_reg"></span></p>
		<p># of Occupants: <span id="occupants"></span></p>
		
	</div>
	<div  > 
	<textarea rows="4" cols="50" type="text" name="results" id="results"> </textarea>
	</div>
	
	<div class="ui-grid-a ui-responsive">
			<div class="ui-block-a"> <a data-role="button" data-icon="flat-settings" data-theme="d" id="btnCapture" >Capture</a></div>
			<div class="ui-block-b"> <a onclick="exitAlert('Are you sure you want exit App?');" data-role="button" data-icon="flat-settings" data-theme="b" id="btnexitLogCapture" >Exit App</a></div>
	</div>
	
	</div>
	<div data-role="footer" data-theme="e">
		<h4>Location Log  &copy;Lavington Security Limited</h4>
	</div>
</div>

<div data-role="page" id="searchMember">
	<div data-role="header">
		<h1>Search</h1>
		<div data-role="navbar">
	        <ul>
	            <li><a href="#manualcapture"  data-icon="star">Manual</a></li>
				  <li><a href="#ocrcapture"  data-icon="star">OCR</a></li>
				<li><a href="#searchMember" class="ui-btn-active ui-state-persist" data-icon="star">Search</a></li>				
	          				
				
	        </ul>
	    </div>
	</div>
	<div data-role="content">
		<p>Press the Log button to log current location</p>
		<script>
		$(document).ready(function(){		
		$("#btnSaveLocation").click(function(){
		 saveORlog=1;
		if($("#clientName").val()!='' || $("#locationName").val()!='' || $("#pointName").val()!=''){
			findPhone();
			logAlert("Are you sure you want to save this locations?");
			//getLocation();
		}else {
			displayAlert("You need to enter the required details to proceed");
		return;
		}
	
		});
	});
		</script>
	<div id="locationDetails">
	
		<div class="ui-block"><input type="text" required="required" data-clear-btn="true" placeholder="Client:" id="clientName"/></div>
		<div class="ui-block"><input type="text" required="required" data-clear-btn="true" placeholder="Location Name:" id="locationName"/></div>
		<div class="ui-block"><input type="text" required="required" data-clear-btn="true" placeholder="Point Name:" id="pointName"/></div>
		<p>Address: <span id="saveAddress"></span></p>
		<p>Latitude: <span id="latSave"></span></p>
		<p>Longitude: <span id="longSave"></span></p>
	</div>
	
	<div class="ui-grid-a ui-responsive">
			<div class="ui-block-a"> <a data-role="button" data-icon="flat-settings" data-theme="d" id="btnSaveLocation" >Save Loc.</a></div>
			<div class="ui-block-b"> <a onclick="exitAlert('Are you sure you want exit App?');" data-role="button" data-icon="flat-settings" data-theme="b" id="btnexitSetLoc" >Exit App</a></div>
	</div>
	
	</div>
	<div data-role="footer" data-theme="e">
		<h4>Location Log  &copy;Lavington Security Limited</h4>
	</div>
</div>


<script>
function getCameraImage() {
//document.addEventListener('deviceready', this.onDeviceReady.bind(this), false);

document.addEventListener("deviceready", onCameraDeviceReady, false);
function onCameraDeviceReady() {
   // alert(navigator.camera);
	//alert("getCameraImage capturing");
		if(navigator.camera) {
		//alert("At capturing level");
		navigator.camera.getPicture(onCaptureSuccess, onCaptureFail, {
			quality: 100, correctOrientation: true });
			//alert("getCameraImage capturing=>after");
			
			} else {
				alert("The camera seem to have issues.");
			}
}

    }
///capture image 
function onCaptureSuccess(imageData) {
		alert("Processing image");
      textocr.recText(0,imageData, onCameraSuccess, onCameraFail); // removed returnType (here 3) from version 2.0.0
      // for sourceType Use 0,1,2,3 or 4
      // for returnType Use 0,1,2 or 3 // 3 returns duplicates[see table]
      function onCameraSuccess(recognizedText) {
	   var element = document.getElementById('results');	   
	   element.innerHTML=JSON.stringify(recognizedText);	  
      alert(JSON.stringify(recognizedText));
         
            //Use above two lines to show recognizedText in html
            
      }
	  
      function onCameraFail(message) {
            alert('Failed because: ' + message);
      }
}
 function onCaptureFail(message) {
            alert('Capture Failed because: ' + message);
      }


var lat=0;var lng=0;

function getLocation() {
		if(navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(
			geoSuccess, geoError, {maximumAge:0, timeout:30000, enableHighAccuracy: true}
			);
			} else {
				alert("Geolocation is not supported by this browser.");
			}
    }
function geoSuccess(position) {
     lat = position.coords.latitude;
     lng = position.coords.longitude;  
	//var userLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
       //  returnAddress(userLatLng);
		/*
			1. sent to server for interpretation 
			2. return back for display
			3. then log it if the user says yes
		*/
		//alert(lat+" , "+lng);		
		getAddress(lat,lng);
		//createMap(lat,lng);
		
	}
	
 function geoError(error) {
	if (error.code == error.TIMEOUT){
        // Attempt to get GPS loc timed out after 5 seconds, 
        // try low accuracy location
		alert("Attempting to get low accuracy location");
        navigator.geolocation.getCurrentPosition(
               geoSuccess, 
               errorCallback_lowAccuracy,
               {maximumAge:0, timeout:30000, enableHighAccuracy: false});
        return;    
}
 var msg = "<p>Can't get your location (high accuracy attempt). Error = ";
    if (error.code == 1)
        msg += "PERMISSION_DENIED";
    else if (error.code == 2)
        msg += "POSITION_UNAVAILABLE";
    msg += ", msg = "+error.message;
   alert(msg);
}
function errorCallback_lowAccuracy(error) {
    var msg = "<p>Can't get your location (low accuracy attempt). Error = ";
    if (error.code == 1)
        msg += "PERMISSION_DENIED";
    else if (error.code == 2)
        msg += "POSITION_UNAVAILABLE";
    else if (error.code == 3)
        msg += "TIMEOUT";
    msg += ", msg = "+error.message;    
    alert(msg);
}
function getAddress(lat,lng){
var geocoder = L.mapquest.geocoding();
geocoder.reverse([lat,lng], geocodingCallback);
}

function geocodingCallback(error, result) {
  //alert(result);
	  alert(result.results[0].locations[0].street);
      var location = result.results[0].locations[0];
      var street = location.street;
      var city = location.adminArea5;
	 var acAddress=street +","+city;
	 alert(street +", "+city);
	 if(saveORlog==0){
		   document.getElementById("address").innerHTML=street +", "+city;
			//var telNo=$("#loc_telNo").val();
			var logType=$("#logType").val();			
			var telNo= sessionStorage.getItem("telNo");
			telNo=eval("("+telNo+")");
	  ////////////			
		    getAddressFromServer(telNo,simSerial1,simSerial2,lat,lng,fingerOrPin,acAddress,logType);			
		   }
		   
		   else if(saveORlog==1){
		   document.getElementById("saveAddress").innerHTML=street +", "+city;
		  // var telNoSave=$("#telNoSave").val();
		   var telNoSave= sessionStorage.getItem("telNo");
			telNoSave=eval("("+telNo+")");
		   var client=$("#clientName").val();
		   var location=$("#locationName").val();
		   var point=$("#pointName").val();
		   
		   //alert("Tel: "+ telNoSave);
		   saveNewPoints(lat,lng,telNoSave,simSerial1,simSerial2,fingerOrPin,client,location,point,acAddress);		   
		   }
		   			
			//}
          else
             displayAlert("Unable to retrieve your address") ;
}
function createMap(lat,lng){
 var map = L.mapquest.map('map', {
          center: [lat,lng],
          layers: L.mapquest.tileLayer('map'),
          zoom: 14
        });

        L.mapquest.control().addTo(map);
        L.mapquest.geocodingControl().addTo(map);
}

function createStorage(){
var today = new Date();
var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
if (localStorage.getItem('logCounter') === null) {
		localStorage.setItem("logCounter", 0);
		localStorage.setItem("todaysDate", date);			
		}else{		
    var inDate=localStorage.getItem("todaysDate");		
	if(inDate===date ){// if it is today, do nothing
	}else{//
	localStorage.setItem("todaysDate", date);
	localStorage.setItem("logCounter", 0);
 }

		
	}
}
function increaseLogCount(){
   var counter= parseInt(localStorage.getItem("logCounter"));
	counter=counter+1;
  localStorage.setItem("logCounter", counter);
}
	
function checkLogingLimit(){
var flag=false;
var today = new Date();
var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
var inDate=localStorage.getItem("todaysDate");

if(localStorage.getItem("logCounter")>=10 && inDate===date ){
flag= false; 
}
 else{
 flag= true;
 }
 return flag;
}
	var lat;
    var lng;
	function getAddressFromServer(telNo,simSerial1,simSerial2,latitude,longitude,fingerOrPin,address,logType)
	{
		$(document).ready(function(){		
		//var device=getDeviceDetails(); // commented on 09-08-2019
		var device="xxxxxx_yyyyyy";	
		 //alert('simSerialNumber=   ' + simSerial1);
		// alert('simSerialNumber2=   ' + simSerial2);
		var url=serverURL +"saveLogDetails.php";
		//alert("Focused now");
		$.ajax(
		{	
        // Post select to url.
        type : 'post',
        url : url,
        dataType : 'text', // expected returned data format.
        data : {
		latitude:latitude,
		longitude:longitude,
		device:device,
		simSerial1:simSerial1,
		simSerial2:simSerial2,
		telNo:telNo,
		fingerOrPin:fingerOrPin,
		address:address,
		logType:logType
        },
        success : function(data){		
		displayAlert("You are done logging this location");
		//findPhone();
		},
	error:function(data,e) {
    if (data.status==0) {
        alert('You are offline!!\n Please Check Your Network.');
    } else if(data.status==404) {
        alert('Requested URL not found.');
    } else if(data.status==500) {
        alert('Internel Server Error.');
    } else if(e=='parsererror') {
        alert('Error.\nParsing JSON Request failed.');
    } else if(e=='timeout'){
        alert('Request Time out.');
    } else {
        alert('Unknow Error.\n'+data.responseText);
		}
	},
        complete : function(data){		
			document.getElementById("latitude").innerHTML=latitude;
			document.getElementById("longitude").innerHTML=longitude;
			}
		});
		});
	}	
	function saveNewPoints(latitude,longitude,telNo,simSerial1,simSerial2,fingerOrPin,client,location,point,address){
		$(document).ready(function(){		
		//var device=getDeviceDetails(); //commented on 09-08-2019
		var device="xxxxxx_yyyyyy";			 
		var url=serverURL +"saveLocationDetails.php";
		//alert("Focused now");
		$.ajax(
		{	
        // Post select to url.
        type : 'post',
        url : url,
        dataType : 'text', // expected returned data format.
        data : {
		latitude:latitude,
		longitude:longitude,
		telNo:telNo,
		simSerial1:simSerial1,
		simSerial2:simSerial2,
		device:device,
		client:client,
		location:location,
		point:point,
		fingerOrPin:fingerOrPin,
		address:address
        },
        success : function(data){		
		displayAlert("You are done saving this point");
		//findPhone();
		},
	error:function(data,e) {
    if (data.status==0) {
        alert('You are offline!!\n Please Check Your Network.');
    } else if(data.status==404) {
        alert('Requested URL not found.');
    } else if(data.status==500) {
        alert('Internel Server Error.');
    } else if(e=='parsererror') {
        alert('Error.\nParsing JSON Request failed.');
    } else if(e=='timeout'){
        alert('Request Time out.');
    } else {
        alert('Unknow Error.\n'+data.responseText);
		}
	},
        complete : function(data){		
			document.getElementById("latSave").innerHTML=latitude;
			document.getElementById("longSave").innerHTML=longitude;
			}
    });
	});

}
	//================================
	function findPhone(){
	 document.addEventListener('deviceready', this.onDeviceReady.bind(this), false);
	 //hasReadPermission();
	}
	function onDeviceReady(){	
	hasReadPermission();
	}
	function HasPerminionSuccessCallback(result) {
		if (result) {
			//window.plugins.sim.getSimInfo(simInfosuccessCallback, errorCallback);
			window.plugins.sim.getSimInfo(simInfosuccessCallback, errorCallback);
		} else {
			requestReadPermission();
		}
	}
	function errorCallback(error) {
		var elementSimInfo = document.getElementById('ErrorInfo');
		elementSimInfo.innerHTML = error;
	}
	function requestSuccessCallback(result) {
    if (result) {
        hasReadPermission();
    }
	}
// Android only: check permission
	function hasReadPermission() {
		window.plugins.sim.hasReadPermission(HasPerminionSuccessCallback, errorCallback);
		//window.plugins.camera.hasReadPermission(HasPerminionSuccessCallback, errorCallback);
	}
// Android only: request permission
	function requestReadPermission() {
	//window.plugins.camera.requestReadPermission(requestSuccessCallback, errorCallback);
	window.plugins.sim.requestReadPermission(requestSuccessCallback, errorCallback);
	}
	function simInfosuccessCallback(result) {
    if (result !== undefined && result != null && result != '') {				  
				/*alert('carrierName=  ' + result.carrierName);                 
                alert('phoneType =   ' + result.phoneType);                
                alert('phoneNumber=  ' + result.phoneNumber);
				alert('simSerialNumber=   ' + result.simSerialNumber);
                alert('subscriberId=  ' + result.subscriberId );
				alert("No. of Cards=  "+ result.cards.length + "Phone Count= "+ result.phoneCount);
				*/
				simSerial1=result.simSerialNumber;				
     }
	 if (result.cards.length > 0 && result.phoneCount > 1) {
		  /*alert('displayName[1]=  ' + result.cards[0].displayName);
		  alert('displayName[2]=  ' + result.cards[1].displayName);
		  alert('simSlotIndex[1]' + result.cards[0].simSlotIndex );
		  alert('simSlotIndex[2]' + result.cards[1].simSlotIndex ); 
		  alert('phoneNumber[1]=  ' + result.cards[0].phoneNumber);
		  alert('phoneNumber[2]=  ' + result.cards[1].phoneNumber);
		  alert('simSerialNumber[1]=   ' + result.cards[0].simSerialNumber);
		  alert('simSerialNumber[2]=   ' + result.cards[1].simSerialNumber);*/
		  //alert('subscriberId[1]=  ' + result.cards[0].subscriberId );	
		  //alert('subscriberId[2]=  ' + result.cards[1].subscriberId );	
		  simSerial1=result.cards[0].simSerialNumber;
	       simSerial2=result.cards[1].simSerialNumber;
		  
	  }
	}
	//==============================
	function getDeviceDetails(){
	  return  device.model +"_"+ device.uuid; 
			  
	}
	function readFingerprint(){			
		FingerprintAuth.isAvailable(function (result) {
			//console.log("FingerprintAuth available: " + JSON.stringify(result));			
			if (result.isAvailable == true && result.hasEnrolledFingerprints == true) {
         var encryptConfig = {
            clientId: "myAppName",
            username: "currentUser",
            password: "currentUserPassword",
            maxAttempts: 5,
            locale: "en_US",
            dialogTitle: "Scan Finger",
            dialogMessage: "Kindly put your registered finger on the device",
            dialogHint: "Ensure that you see the Successfully logged message "
        }; // See config object for required parameters
        // Set config and success callback
        FingerprintAuth.encrypt(encryptConfig, function(_fingerResult){
            //console.log("successCallback(): " + JSON.stringify(_fingerResult));
            if (_fingerResult.withFingerprint) {
                //console.log("Successfully Successfully logged location.");				
				//console.log("Encrypted credentials: " + result.token);		
			fingerOrPin=0;
			getLocation();//Display the current possition            
			} else if (_fingerResult.withBackup) {
				fingerOrPin=1;
				getLocation();
			console.log("Authenticated with backup password");
		   // alert("Authenticated with backup password");
            }
        // Error callback
        }, function(err){
                if (err === "Cancelled") {
                console.log("FingerprintAuth Dialog Cancelled!");
			 displayAlert("FingerprintAuth Dialog Cancelled!");			
            } else {
             console.log("FingerprintAuth Error: " + err);
		     displayAlert("FingerprintAuth Error: " + err);
            }
        });
    }
	else {
	displayAlert("Fingerprint availability error: Available=  "+ result.isAvailable + "  Enrolled=  " +result.hasEnrolledFingerprints + "  isHardwareDetected=  "+ result.isHardwareDetected);

 }
		/**
		* @return {
		*      isAvailable:boolean,
		*      isHardwareDetected:boolean,
		*      hasEnrolledFingerprints:boolean
		*   }
		*/
	}, function (message) {
		console.log("isAvailableError(): " + message);
	  alert("isAvailableError(): " + message);
		});
	}
function logSavePayAlert(msg) {
		dialog.style.cssText = "color: red; background-color: black; border: 1px solid red"; 	
		document.getElementById("alertclass1").innerHTML=msg;
			$( "#dialog" ).dialog({
			autoOpen: true,
			modal: true,
			width: 300,
			height: 200,
			buttons:{
			Yes: function() {
			$(this).dialog("close");			
			//1. Call the fingerprint function and then
			savePayrollChanges();
			//Call log location function
    },
		No: function() {
        $(this).dialog("close");
    }
		},
		show: {
		effect: "slide",
		duration: 200
		},
		hide: {
		effect: "fade",
		duration: 200
		}	
		});		
	$( ".selector" ).dialog({
		closeOnEscape: false
		});
  }	
	function logAlert(msg) {
		dialog.style.cssText = "color: red; background-color: black; border: 1px solid red"; 	
		document.getElementById("alertclass1").innerHTML=msg;
			$( "#dialog" ).dialog({
			autoOpen: true,
			modal: true,
			width: 300,
			height: 200,
			buttons:{
			Yes: function() {
			$(this).dialog("close");			
			//1. Call the fingerprint function and then
			readFingerprint(); //commented on 11-08-2019
			increaseLogCount(); 
			//Call log location function
    },
		No: function() {
        $(this).dialog("close");
    }
		},
		show: {
		effect: "slide",
		duration: 200
		},
		hide: {
		effect: "fade",
		duration: 200
		}	
		});		
	$( ".selector" ).dialog({
		closeOnEscape: false
		});
  }
  	function exitAlert(msg) {
		dialog.style.cssText = "color: red; background-color: black; border: 1px solid red"; 	
		document.getElementById("alertclass1").innerHTML=msg;
	  $( "#dialog" ).dialog({
		autoOpen: true,
		modal: true,
		width: 300,
		height: 200,
		buttons:{
		
		Yes: function() {
			$(this).dialog("close");		
			endSession();
			navigator.app.exitApp();        
		},
			No: function() {
			$(this).dialog("close");			
			}
		},
		show: {
		effect: "slide",
		duration: 200
		},
		hide: {
		effect: "fade",
		duration: 200
		}	
		});		
	$( ".selector" ).dialog({
		closeOnEscape: false
		});
  }   
	function displayAlert(response) {
	dialog.style.cssText = "color: red; background-color: black; border: 1px solid red"; 	
	document.getElementById("alertclass1").innerHTML=response;
	  $( "#dialog" ).dialog({
		autoOpen: true,
		modal: true,
		width: 300,
		height: 200,
		buttons: {
		Ok: function() {
		$( this ).dialog( "close" );
		}
		},
		show: {
		effect: "slide",
		duration: 200
		},
		hide: {
		effect: "fade",
		duration: 200
		}	
		});		
	$( ".selector" ).dialog({
		closeOnEscape: false
		});
  } 
  function savePayrollChanges(){
	  console.log("Saving");
	  var pfIDNo=$("#pfIDNo").val();
	  var empNames=$("#empNames").val();
	  var assignment=$("#assignment").val();
	  var dateDeployedLeft= $("#dateDeployedLeft").val();
	  //var salaryMonth= $("#salaryMonth").val();	 
		var dateString = new Date();
		var dd = dateString.getDate();
		var mm = dateString.getMonth() + 1; // getMonth() is zero-based
		var yy = dateString.getFullYear();
		var salaryMonth= yy+"-"+mm+"-"+dd;
		//alert(yy);
	  var daysWorked= $("#daysWorked").val();
	  var changeType= $("#changeType").val();
	  var changeTypeDesc=$('#changeType option:selected').text();
	  //alert(changeType);
	  var telNo= sessionStorage.getItem("telNo");
	  telNo=eval("("+telNo+")");
	  console.log("PF is  "+pfIDNo );
	var url=serverURL +"savePayrollChanges.php";
		//alert("Focused now");
		$.ajax(
		{	
        // Post select to url.
        type : 'post',
        url : url,
        dataType : 'text', // expected returned data format.
        data : {
		pfIDNo:pfIDNo,
		empNames:empNames,
		assignment:assignment,
		dateDeployedLeft:dateDeployedLeft,
		salaryMonth:salaryMonth,
		daysWorked:daysWorked,
		changeType:changeType,
		changeTypeDesc:changeTypeDesc,
		telNo:telNo		
        },
        success : function(data){		
		//displayAlert("You are done saving this change");
		displayAlert(eval("("+data+")"));
		document.getElementById("changeType").selectedIndex = 1; 
		$('#changeType').prop('selectedindex',1);
		$('#changeType').trigger("chosen:updated");		
		$('#changeType option').prop('selected', function() {
        return this.defaultSelected;
			});
        //$('#changeType').find('option:first').attr('selected', 'selected');
		//$("#changeType").val("");
		//$('#changeType').get(0).selectedIndex = 0;
		//$('#changeType option:selected').text("");	
		//findPhone();
		},
	error:function(data,e) {
    if (data.status==0) {
        alert('You are offline!!\n Please Check Your Network.');
    } else if(data.status==404) {
        alert('Requested URL not found.');
    } else if(data.status==500) {
        alert('Internel Server Error.');
    } else if(e=='parsererror') {
        alert('Error.\nParsing JSON Request failed.');
    } else if(e=='timeout'){
        alert('Request Time out.');
    } else {
        alert('Unknow Error.\n'+data.responseText);
		}
	},
        complete : function(data){	
				
			//document.getElementById("latitude").innerHTML=latitude;
			//document.getElementById("longitude").innerHTML=longitude;
			}
		});
  }
  function storeSession(usn,names,telNo,supID){	
	// a function to store the username session name and display who is logged in	 
	sessionStorage.setItem('usn',JSON.stringify(usn));	
	sessionStorage.setItem('names',JSON.stringify(names));
	sessionStorage.setItem('telNo',JSON.stringify(telNo));
	//sessionStorage.setItem('supID',JSON.stringify(supID));	
		globalusn=usn;
		globalNames=names;
		globalTelNo=telNo;
		}
	
	function endSession(){	
	// a function to store the username session name and display who is logged in	 
	sessionStorage.setItem('usn',JSON.stringify(''));	
	sessionStorage.setItem('names',JSON.stringify(''));
	sessionStorage.setItem('telNo',JSON.stringify(''));	
	//sessionStorage.setItem('supID',JSON.stringify(''));	
		globalusn='';
		globalNames='';
		globalTelNo='';		
		}
		
	function checkLengthLogin(el,screen,button) {
		$(button).attr("disabled", true);		
		if (el.value.length<4 || el.value.length>12){
			$(button).attr("disabled", true);
			$(el).focus();			
			el.style.cssText = "color: red; border: 1px solid red"; 		
		document.getElementById(screen).innerHTML="The length must be between 4 and 12 characters; The button is disabled";					

	 }else {
	 $(button).attr("disabled", false);
	// el.classList.remove('invalid');
	 el.style.color = null;
	 el.style.border = null;
     document.getElementById(screen).innerHTML=  "";		
	 }
	}
	function readSession(){ //checking if the session has a login value
		var s=sessionStorage.getItem("usn");
		return s;	 
	}


	
    function checkonPageshow(){// on click of back and forward button, we check if the login session is still active
	console.log("Checking session ");	
	try{
	if (sessionStorage.getItem('usn')){		
	var originalValue = JSON.parse(sessionStorage.getItem('usn')); //outputs null
		if (originalValue == null || originalValue==''){			
			var urld2=baseURL +"index.html#mfloginPage";
			var urld3=baseURL +"index.html#changePassword";				
			if(window.location.href==urld2)
			{//do nothing
			
			}
			if(window.location.href==urld3)
			{//do nothing
			//window.location.replace(baseURL +"index.html#changePassword");
			window.location.replace("index.html#changePassword");
			console.log("Password replace 1");
			}
			else{
				//window.location.replace(baseURL +"index.html#mfloginPage");
				window.location.replace("index.html#mfloginPage");
				//location.reload(true);	
			} 
		}
		else{ //Stay on where you are  
		//window.location.href = baseURL +"index.html";
		}
	}else{
			var urld2=baseURL +"index.html#mfloginPage";
			var urld3=baseURL +"index.html#changePassword";				
			 if(window.location.href==urld2){
			 //do nothing
			 //window.location.replace(baseURL +"index.html#changePassword");
			}
			if(window.location.href==urld3)
			{//do nothing
			window.location.replace("index.html#changePassword");
			console.log("Password replace 2");
			}
			else{			
				window.location.replace("index.html#mfloginPage");
				//location.reload(true);
				} 
		
	}
	}
	catch(e){}
	}
</script>
</body>
</html>

